test:
  pre:
    - bower install
    - bower prune

  post:
    - bundle exec rake rubocop
    - bundle exec rake scss_lint
    - bundle exec rake doc:suggest
    - bundle exec bundle-audit check --update
    - bundle exec brakeman -z -A -w1
    - bundle exec dawn --html -F $CIRCLE_ARTIFACTS/dawn.html .

deployment:
  production:
    branch: master
    commands:
      - '[[ ! -s "$(git rev-parse --git-dir)/shallow" ]] || git fetch --unshallow'
      - git push git@heroku.com:boussole-de-droits.git $CIRCLE_SHA1:master
      - heroku run rake db:migrate data:migrate -a boussole-de-droits
